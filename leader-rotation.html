<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Leader Rotation - Solana: Blockchain Rebuilt for Scale</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="terminology.html"><strong aria-hidden="true">2.</strong> Terminology</a></li><li><a href="getting-started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li><a href="programs.html"><strong aria-hidden="true">4.</strong> Programming Model</a></li><li><a href="cluster.html"><strong aria-hidden="true">5.</strong> A Solana Cluster</a></li><li><ol class="section"><li><a href="synchronization.html"><strong aria-hidden="true">5.1.</strong> Synchronization</a></li><li><a href="storage.html"><strong aria-hidden="true">5.2.</strong> Ledger Replication</a></li><li><a href="leader-rotation.html" class="active"><strong aria-hidden="true">5.3.</strong> Leader Rotation</a></li></ol></li><li><a href="fullnode.html"><strong aria-hidden="true">6.</strong> Anatomy of a Fullnode</a></li><li><ol class="section"><li><a href="tpu.html"><strong aria-hidden="true">6.1.</strong> TPU</a></li><li><a href="tvu.html"><strong aria-hidden="true">6.2.</strong> TVU</a></li><li><a href="ncp.html"><strong aria-hidden="true">6.3.</strong> NCP</a></li><li><a href="runtime.html"><strong aria-hidden="true">6.4.</strong> The Runtime</a></li></ol></li><li><a href="appendix.html"><strong aria-hidden="true">7.</strong> Appendix</a></li><li><ol class="section"><li><a href="jsonrpc-api.html"><strong aria-hidden="true">7.1.</strong> JSON RPC API</a></li><li><a href="wallet.html"><strong aria-hidden="true">7.2.</strong> solana-wallet CLI</a></li></ol></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Solana: Blockchain Rebuilt for Scale</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#leader-rotation" id="leader-rotation"><h1>Leader Rotation</h1></a>
<p>A property of any permissionless blockchain is that the entity choosing the next block is randomly selected. In proof of stake systems,
that entity is typically called the &quot;leader&quot; or &quot;block producer.&quot; In Solana, we call it the leader. Under the hood, a leader is
simply a mode of the fullnode. A fullnode runs as either a leader or validator. In this chapter, we describe how a fullnode determines
what node is the leader, how that mechanism may choose different leaders at the same time, and if so, how the system converges in response.</p>
<a class="header" href="#leader-seed-generation" id="leader-seed-generation"><h2>Leader Seed Generation</h2></a>
<p>Leader scheduling is decided via a random seed.  The process is as follows:</p>
<ol>
<li>Periodically, at a specific PoH tick count, select the signatures of the votes that made up the last supermajority</li>
<li>Concatenate the signatures</li>
<li>Hash the resulting string for <code>N</code> counts</li>
<li>The resulting hash is the random seed for <code>M</code> counts, <code>M</code> leader slots, where M &gt; N</li>
</ol>
<a class="header" href="#leader-rotation-1" id="leader-rotation-1"><h2>Leader Rotation</h2></a>
<ol>
<li>The leader is chosen via a random seed generated from stake weights and votes (the leader schedule)</li>
<li>The leader is rotated every <code>T</code> PoH ticks (leader slot), according to the leader schedule</li>
<li>The schedule is applicable for <code>M</code> voting rounds</li>
</ol>
<p>Leader's transmit for a count of <code>T</code> PoH ticks.  When <code>T</code> is reached all the validators should switch to the next scheduled leader.  To schedule leaders, the supermajority + <code>M</code> nodes are shuffled using the above calculated random seed.</p>
<p>All <code>T</code> ticks must be observed from the current leader for that part of PoH to be accepted by the network.  If <code>T</code> ticks (and any intervening transactions) are not observed, the network optimistically fills in the <code>T</code> ticks, and continues with PoH from the next leader.</p>
<a class="header" href="#partitions-forks" id="partitions-forks"><h2>Partitions, Forks</h2></a>
<p>Forks can arise at PoH tick counts that correspond to leader rotations, because leader nodes may or may not have observed the previous leader's data.  These empty ticks are generated by all nodes in the network at a network-specified rate for hashes-per-tick <code>Z</code>.</p>
<p>There are only two possible versions of the PoH during a voting round: PoH with <code>T</code> ticks and entries generated by the current leader, or PoH with just ticks.  The &quot;just ticks&quot; version of the PoH can be thought of as a virtual ledger, one that all nodes in the network can derive from the last tick in the previous slot.</p>
<p>Validators can ignore forks at other points (e.g. from the wrong leader), or slash the leader responsible for the fork.</p>
<p>Validators vote on the longest chain that contains their previous vote, or a longer chain if the lockout on their previous vote has expired.</p>
<a class="header" href="#validators-view" id="validators-view"><h4>Validator's View</h4></a>
<a class="header" href="#time-progression" id="time-progression"><h5>Time Progression</h5></a>
<p>The diagram below represents a validator's view of the PoH stream with possible forks over time.  L1, L2, etc. are leader slots, and <code>E</code>s represent entries from that leader during that leader's slot.  The <code>x</code>s represent ticks only, and time flows downwards in the diagram.</p>
<p><img alt="Leader scheduler" src="img/leader-scheduler.svg" class="center"/></p>
<p>Note that an <code>E</code> appearing on 2 branches at the same slot is a slashable condition, so a validator observing <code>L3</code> and <code>L3'</code> can slash L3 and safely choose <code>x</code> for that slot.  Once a validator observes a supermajority vote on any branch, other branches can be discarded below that tick count.  For any slot, validators need only consider a single &quot;has entries&quot; chain or a &quot;ticks only&quot; chain.</p>
<a class="header" href="#time-division" id="time-division"><h5>Time Division</h5></a>
<p>It's useful to consider leader rotation over PoH tick count as time division of the job of encoding state for the network.  The following table presents the above tree of forks as a time-divided ledger.</p>
<table><thead><tr><th>leader slot </th><th>  L1 </th><th> L2 </th><th> L3 </th><th> L4 </th><th> L5</th></tr></thead><tbody>
<tr><td>data      </td><td>  E1</td><td> E2 </td><td> E3 </td><td> E4  </td><td> E5</td></tr>
<tr><td>ticks since prev  </td><td> </td><td> </td><td> </td><td> x </td><td> xx</td></tr>
</tbody></table>
<p>Note that only data from leader <code>L3</code> will be accepted during leader slot
<code>L3</code>.  Data from <code>L3</code> may include &quot;catchup&quot; ticks back to a slot other than
<code>L2</code> if <code>L3</code> did not observe <code>L2</code>'s data.  <code>L4</code> and <code>L5</code>'s transmissions
include the &quot;ticks since prev&quot; PoH entries.</p>
<p>This arrangement of the network data streams permits nodes to save exactly this
to the ledger for replay, restart, and checkpoints.</p>
<a class="header" href="#leaders-view" id="leaders-view"><h4>Leader's View</h4></a>
<p>When a new leader begins a slot, it must first transmit any PoH (ticks)
required to link the new slot with the most recently observed and voted
slot.</p>
<a class="header" href="#examples" id="examples"><h2>Examples</h2></a>
<a class="header" href="#small-partition" id="small-partition"><h3>Small Partition</h3></a>
<ol>
<li>Network partition <code>M</code> occurs for 10% of the nodes</li>
<li>The larger partition <code>K</code>, with 90% of the stake weight continues to operate as
normal</li>
<li><code>M</code> cycles through the ranks until one of them is leader, generating ticks for
slots where the leader is in <code>K</code>.</li>
<li><code>M</code> validators observe 10% of the vote pool, finality is not reached.</li>
<li><code>M</code> and <code>K</code> reconnect.</li>
<li><code>M</code> validators cancel their votes on <code>M</code>, which has not reached finality, and
re-cast on <code>K</code> (after their vote lockout on <code>M</code>).</li>
</ol>
<a class="header" href="#leader-timeout" id="leader-timeout"><h3>Leader Timeout</h3></a>
<ol>
<li>Next rank leader node <code>V</code> observes a timeout from current leader <code>A</code>, fills in
<code>A</code>'s slot with virtual ticks and starts sending out entries.</li>
<li>Nodes observing both streams keep track of the forks, waiting for:
<ul>
<li>their vote on leader <code>A</code> to expire in order to be able to vote on <code>B</code></li>
<li>a supermajority on <code>A</code>'s slot</li>
</ul>
</li>
<li>If the first case occurs, leader <code>B</code>'s slot is filled with ticks. if the
second case occurs, A's slot is filled with ticks</li>
<li>Partition is resolved just like in the <a href="#small-parition">Small Partition</a>
above</li>
</ol>
<a class="header" href="#network-variables" id="network-variables"><h2>Network Variables</h2></a>
<p><code>A</code> - name of a node</p>
<p><code>B</code> - name of a node</p>
<p><code>K</code> - number of nodes in the supermajority to whom leaders broadcast their
PoH hash for validation</p>
<p><code>M</code> - number of nodes outside the supermajority to whom leaders broadcast their
PoH hash for validation</p>
<p><code>N</code> - number of voting rounds for which a leader schedule is considered before
a new leader schedule is used</p>
<p><code>T</code> - number of PoH ticks per leader slot (also voting round)</p>
<p><code>V</code> - name of a node that will create virtual ticks</p>
<p><code>Z</code> - number of hashes per PoH tick</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="storage.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="fullnode.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="storage.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="fullnode.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
